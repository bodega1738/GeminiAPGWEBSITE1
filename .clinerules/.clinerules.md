# Cline Rules for Maritime CRM Migration

## MANDATORY: Read These Files FIRST Before Any Work

1. **ALWAYS read AI_AGENT_INDEX.md first** - Master navigation
2. **ALWAYS read MCP_POLICY.md** - Enforcement policy
3. **ALWAYS check MIGRATION_LOG.md** - Current status
4. **ALWAYS consult AI_DEVELOPMENT_PLAYBOOK.md** - Step-by-step guide for current phase

## MCP Policy Enforcement (CRITICAL)

### Before ANY Development Work:

1. **READ MCP_POLICY.md completely**
2. **IDENTIFY component type** (Convex, BetterAuth, XState, etc.)
3. **USE MCP TOOLS to study reference repositories**
   - For Convex work: Study "Convex Backend Docs" MCP server
   - For Auth work: Study "BetterAuth Docs" MCP server
   - For State machines: Study "XState Docs" MCP server
4. **CACHE findings** and document what you learned
5. **MAP patterns** to your specific task
6. **DOCUMENT decisions** in MIGRATION_LOG.md

### MCP Study Requirements:

**For Convex Backend Work:**
- MUST study: Convex Backend Docs (https://gitmcp.io/get-convex/convex-backend)
- Focus on: Schema, queries, mutations, components, type system
- Document: What patterns you learned and applied

**For BetterAuth Work:**
- MUST study: BetterAuth Docs (https://gitmcp.io/better-auth/better-auth)
- Focus on: Convex integration, component API, authentication patterns
- Document: What patterns you learned and applied

**For XState Work:**
- MUST study: XState Docs (https://gitmcp.io/statelyai/xstate)
- Focus on: State machines, persistence, Convex integration
- Document: What patterns you learned and applied

## Error Handling Rules

1. **ALWAYS check ERROR_KNOWLEDGE_BASE.md** before trying solutions
2. **NEVER guess** - if unsure, read MCP docs or ask for clarification
3. **STOP if spiraling** - if you try 3 approaches and all fail, STOP and ask for help
4. **DOCUMENT new errors** - Add to ERROR_KNOWLEDGE_BASE.md immediately

## Anti-Spiral Rules (CRITICAL)

### If You Encounter Errors:

1. **First attempt fails?** → Check ERROR_KNOWLEDGE_BASE.md for known solutions
2. **Second attempt fails?** → Read MCP docs for the specific component
3. **Third attempt fails?** → STOP and ask user for guidance

### NEVER:
- ❌ Try more than 3 different approaches without asking
- ❌ Guess at API methods or package names
- ❌ Install packages without verifying on npmjs.com
- ❌ Use source code patterns without official doc confirmation

## Documentation Update Rules

**After EVERY task completion:**
1. Update MIGRATION_LOG.md with chronological entry
2. Update phase tracking dashboard
3. Document any errors encountered
4. Update ERROR_KNOWLEDGE_BASE.md if new errors found

## Phase-Specific Rules

### Current Phase: Phase 4 - Authentication

**MUST DO:**
1. Read BetterAuth Docs via MCP FIRST
2. Read Convex Backend Docs via MCP for component usage
3. Follow EXACT patterns from official docs
4. Test with `npx convex dev` after each change
5. If TypeScript errors persist after 2 attempts, use simplified Convex built-in auth

**MUST NOT:**
- ❌ Guess at BetterAuth API methods
- ❌ Try random import patterns
- ❌ Install packages named `tsc` (use `typescript` instead)
- ❌ Mix Convex built-in auth with BetterAuth (choose ONE)

## Success Criteria Verification

**Before marking any phase as COMPLETE:**
1. ✅ Run `npx convex dev` - must show "Convex functions ready!" with NO errors
2. ✅ Check TypeScript diagnostics - must be ZERO errors
3. ✅ Test the functionality - must work as expected
4. ✅ Update all documentation - MIGRATION_LOG.md, ERROR_KNOWLEDGE_BASE.md

## File References

- Master Index: `AI_AGENT_INDEX.md`
- Policy: `MCP_POLICY.md`
- Progress: `MIGRATION_LOG.md`
- Playbook: `AI_DEVELOPMENT_PLAYBOOK.md`
- Errors: `ERROR_KNOWLEDGE_BASE.md`
- Decisions: `ARCHITECTURE_DECISIONS.md`